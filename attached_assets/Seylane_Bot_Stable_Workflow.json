{
  "name": "Seylane Bot - Stable v2",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "replit",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "ğŸ“© Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "seylane-stable-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-1",
              "leftValue": "={{ $json.body.messages }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-valid-input",
      "name": "âœ… Valid Input?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "// Extract last user message\nconst messages = $input.item.json.body.messages || [];\n\nlet userMessage = \"Ø³Ù„Ø§Ù…\";\nfor (let i = messages.length - 1; i >= 0; i--) {\n  if (messages[i].role === \"user\") {\n    userMessage = messages[i].content || \"\";\n    break;\n  }\n}\n\n// Clean message\nuserMessage = userMessage.trim().replace(/[\\u0000-\\u001F\\u007F-\\u009F]/g, '');\n\nreturn {\n  userMessage: userMessage,\n  systemPrompt: $input.item.json.body.systemPrompt || \"\",\n  affiliateLink: $input.item.json.body.affiliateLink || \"\"\n};"
      },
      "id": "extract-message",
      "name": "ğŸ” Extract Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 200]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.0-flash-exp",
          "mode": "list",
          "cachedResultName": "Gemini 2.0 Flash"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.userMessage }}"
            }
          ]
        },
        "jsonOutput": true,
        "options": {
          "systemMessage": "={{ $json.systemPrompt }}",
          "maxOutputTokens": 250,
          "temperature": 0.8,
          "timeout": 30000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [900, 200],
      "id": "gemini-ai",
      "name": "ğŸ¤– Gemini AI",
      "continueOnFail": true,
      "credentials": {
        "googlePalmApi": {
          "id": "UT1iahfaFNxVbfVf",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Clean Gemini response and extract pure text\nlet messageText = \"\";\n\ntry {\n  const raw = $input.item.json;\n  \n  // Try multiple paths to find the response\n  if (raw[0]?.content?.parts?.[0]?.text) {\n    messageText = raw[0].content.parts[0].text;\n  } else if (raw.content?.parts?.[0]?.text) {\n    messageText = raw.content.parts[0].text;\n  } else if (typeof raw === \"string\") {\n    messageText = raw;\n  } else if (raw.message) {\n    messageText = raw.message;\n  } else {\n    messageText = JSON.stringify(raw);\n  }\n  \n  // Clean the text\n  messageText = messageText.trim();\n  \n  // Remove JSON formatting if present\n  if (messageText.startsWith('{') || messageText.startsWith('[')) {\n    try {\n      const parsed = JSON.parse(messageText);\n      messageText = parsed.response || parsed.message || parsed.text || messageText;\n    } catch (e) {\n      // Try regex extraction for incomplete JSON\n      const match = messageText.match(/\"(?:response|message|text)\"\\s*:\\s*\"([^\"]+)\"/s);\n      if (match) {\n        messageText = match[1];\n      }\n    }\n  }\n  \n  // Remove markdown code blocks\n  messageText = messageText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n  \n  // Remove quotes if the entire string is quoted\n  if (messageText.startsWith('\"') && messageText.endsWith('\"')) {\n    messageText = messageText.slice(1, -1);\n  }\n  \n  // Unescape characters\n  messageText = messageText.replace(/\\\\n/g, '\\n').replace(/\\\\\"/g, '\"');\n  \n} catch (error) {\n  messageText = \"Ø³Ù„Ø§Ù… ğŸŒ¿ Ù¾ÛŒØ§Ù…Øª Ø±Ùˆ Ø¯ÛŒØ¯Ù… - Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ ÛŒÚ©Ù… Ø¨ÛŒØ´ØªØ± Ø¨Ú¯ÛŒ ØªØ§ Ø¨ØªÙˆÙ†Ù… Ø¯Ø±Ø³Øª Ú©Ù…Ú©Øª Ú©Ù†Ù…ØŸ\";\n}\n\n// Detect if affiliate link should be sent\nconst sendLink = (\n  messageText.includes('Ø§ÙÛŒÙ„ÛŒØª') ||\n  messageText.includes('Ù‡Ù…Ú©Ø§Ø±') ||\n  messageText.includes('Ø«Ø¨Øª Ù†Ø§Ù…') ||\n  messageText.includes('Ú©Ø¯ ØªØ®ÙÛŒÙ')\n);\n\nreturn {\n  message: messageText || \"Ø³Ù„Ø§Ù… ğŸŒ¿ Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú©Øª Ú©Ù†Ù…ØŸ\",\n  sendLink: sendLink\n};"
      },
      "id": "format-response",
      "name": "âœ¨ Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "jsCode": "// Fallback response when AI fails\nreturn {\n  message: \"Ø³Ù„Ø§Ù… ğŸŒ¿ Ù¾ÛŒØ§Ù…Øª Ø±Ùˆ Ø¯ÛŒØ¯Ù… - Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ ÛŒÚ©Ù… Ø¨ÛŒØ´ØªØ± Ø¨Ú¯ÛŒ ØªØ§ Ø¨ØªÙˆÙ†Ù… Ø¯Ø±Ø³Øª Ú©Ù…Ú©Øª Ú©Ù†Ù…ØŸ\",\n  sendLink: false\n};"
      },
      "id": "fallback-response",
      "name": "âš ï¸ Fallback",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400]
    },
    {
      "parameters": {
        "jsCode": "// Invalid input response\nreturn {\n  message: \"Ø³Ù„Ø§Ù… ğŸŒ¿ Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú©Øª Ú©Ù†Ù…ØŸ\",\n  sendLink: false\n};"
      },
      "id": "invalid-input",
      "name": "âŒ Invalid Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "respond-webhook",
      "name": "ğŸ“¤ Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1340, 300]
    }
  ],
  "connections": {
    "ğŸ“© Webhook": {
      "main": [
        [
          {
            "node": "âœ… Valid Input?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… Valid Input?": {
      "main": [
        [
          {
            "node": "ğŸ” Extract Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âŒ Invalid Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Extract Message": {
      "main": [
        [
          {
            "node": "ğŸ¤– Gemini AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– Gemini AI": {
      "main": [
        [
          {
            "node": "âœ¨ Format Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âš ï¸ Fallback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ¨ Format Response": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš ï¸ Fallback": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âŒ Invalid Input": {
      "main": [
        [
          {
            "node": "ğŸ“¤ Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-01-22T18:00:00.000Z",
  "versionId": "stable-v2"
}
