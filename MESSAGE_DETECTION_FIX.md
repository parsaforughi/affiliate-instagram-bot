# Message Detection Fix

## Problem
در برخی جاها تشخیص user و bot اشتباه بود (بعضی پیام‌های کاربر به عنوان bot و برعکس تشخیص داده می‌شدند)

## Solution
بهبود منطق تشخیص با سیستم امتیازدهی اعتماد (Confidence Scoring)

### روش‌های تشخیص:

1. **Seen Indicator** (امتیاز: 5) - قوی‌ترین شاخص
   - فقط روی پیام‌های ارسالی (bot) نمایش داده می‌شود
   - جستجو در: `img[alt*="Seen"]` و `svg[aria-label*="Seen"]`

2. **Read Receipt** (امتیاز: 4) - بسیار قابل اعتماد
   - فقط روی پیام‌های ارسالی نمایش داده می‌شود
   - جستجو در: `svg[aria-label*="read"]` و `svg[aria-label*="delivered"]`

3. **Flex-End Alignment** (امتیاز: 2)
   - پیام‌های ارسالی معمولاً راست‌چین هستند
   - بررسی: `justify-content: flex-end`

4. **Parent Container Alignment** (امتیاز: 2)
   - بررسی alignment والدین container

5. **Message Position** (امتیاز: 1)
   - پیام‌های ارسالی معمولاً در سمت راست هستند

### Threshold (آستانه):
- برای تشخیص پیام به عنوان **outgoing (bot)** نیاز به **امتیاز >= 3** است
- این کار false positive را کاهش می‌دهد

### تغییرات:
- اضافه شدن تابع `detectOutgoingMessage()` برای استفاده در همه جا
- بهبود منطق تشخیص در تمام بخش‌های کد
- استفاده از چندین روش تشخیص برای اطمینان بیشتر

## Testing
پس از راه‌اندازی مجدد bot، بررسی کنید:
- آیا پیام‌های کاربر به درستی به عنوان "user" نمایش داده می‌شوند؟
- آیا پیام‌های bot به درستی به عنوان "bot" نمایش داده می‌شوند؟

